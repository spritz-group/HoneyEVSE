<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <scritp src="{{ url_for('static', filename='js/timeme.min.js') }}"></scritp>
    <title>EVSE - HMI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <script type="text/javascript" src="{{ url_for('static', filename='js/timeme.js') }}"></script>
        <script type="text/javascript">
            TimeMe.initialize({
                currentPageName: "/admin",
                idleTimeoutInSeconds: 20
            });
        </script>
        <script type="text/javascript">

            window.addEventListener('beforeunload', (event) => {

                // event.preventDefault();

                // get the request in the logs
                var timeSpentOnPage = TimeMe.getTimeOnCurrentPageInSeconds();
                var thisPage = "/admin"
                xmlhttp=new XMLHttpRequest();
                xmlhttp.open("POST","/admin",false);
                xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xmlhttp.send("timeOnPage=" + timeSpentOnPage + "&page=" + thisPage);

                // Google Chrome requires returnValue to be set.
                // event.returnValue = '';
            });
        </script>
</head>

<body>
    <div id="banner">
        <h1>EVSE - HMI</h1>
    </div>
    <div id="admin">
        <div id="data">
            <div>
                <h3>Vehicle ID: </h3>
                <h3>
                    <p id="id">--</p>
                </h3>
            </div>
            <div>
                <h3>Arrived:</h3>
                <h3>
                    <p id="arrival">--</p>
                </h3>
            </div>
            <div>
                <h3>Estimated Departure Time</h3>
                <h3>
                    <p id="departure">--</p>
                </h3>
            </div>
            <div>
                <h3>Current Charge:</h3>
                <h3>
                    <p id="current_charge">--</p> &#913;
                </h3>
            </div>
            <div>
                <h3>Energy Delivered:</h3>
                <h3>
                    <p id="energy_delivered">--</p> kwH
                </h3>
            </div>
            <div>
                <h3>Precent Complete:</h3>
                <h3>
                    <p id="percent_complete">--</p> %
                </h3>
            </div>
            <div>
                <h3>Total Cost:</h3>
                <h3>
                    <p id="cost">--</p> &euro;
                </h3>
            </div>

            <p>For more actions <a href="/login">login</a> to the admin</p>
        </div>
        <div id="chart-container">
            <canvas id="chart"></canvas>
        </div>
    </div>
    <script>
        /* Simple function to calculate the minutes from a instant of time to another one*/
        function calculateDeparture(arrival, departure) {
            let interval = departure - arrival;
            let dateTime = new Date().getTime();
            return new Date(dateTime + interval * 60000).toLocaleTimeString();
        }

        // get random color for chart
        function getRandomColor() {
            var letters = '0123456789ABCDEF'.split('');
            var color = '#';
            for (var i = 0; i < 6; i++ ) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        /* The function add datas to the chart */
        function addData(chart, label, data, bg_color) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => {
                dataset.label.push(label)
                dataset.data.push(data);
                dataset.backgroundColor.push(bg_color);
            });
            chart.update();
        }

        /* Generate and return a new instance of the Chart in the canvas */
        function newChart(init_label, init_data, bg_color) {
            config = {
                type: "pie",
                data: {
                    labels: [init_label],
                    datasets: [
                        {
                            label: [],
                            data: [init_data],
                            backgroundColor: [bg_color]
                        }
                    ]
                }
            }

            return new Chart('chart', config);
        }
        
        let chart = null;

        let id = document.getElementById("id");
        let arrival = document.getElementById("arrival")
        let departure = document.getElementById("departure");
        let current_charge = document.getElementById("current_charge");
        let energy_delivered = document.getElementById("energy_delivered");
        let percent_complete = document.getElementById("percent_complete");
        let cost = document.getElementById("cost");

        let actualId = document.getElementById("id");
        
        // counter if it is first time retrieving data
        let c = 0;

        setInterval(() => {
            fetch('./status')
                .then(res => res.json())
                .then(json => {
                    // Update values each second
                    id.innerHTML = json.id
                    current_charge.innerHTML = json.current_charge.toFixed(2);
                    energy_delivered.innerHTML = json.energy_delivered.toFixed(2);
                    percent_complete.innerHTML = json.percent_complete.toFixed(2);
                    cost.innerHTML = json.cost.toFixed(2);

                    // If the id is different, it means that there is a new eletric vehicle
                    if (actualId != json.id) {
                        arrival.innerHTML = new Date().toLocaleTimeString();
                        departure.innerHTML = calculateDeparture(json.arrival, json.departure);

                        // create chart with first data available
                        if (c == 0) {
                            chart = newChart(json.id, json.energy_delivered, getRandomColor());
                            c = 1
                        }
                        else {
                            console.log(json)
                            addData(chart, json.id,json.energy_delivered, getRandomColor());
                        }

                        actualId = json.id;
                        console.log(json)
                    }
                    // Initialize date for print timestamp
                    let date = new Date();
                   
                })
        }, 1000);
    </script>
</body>

</html>